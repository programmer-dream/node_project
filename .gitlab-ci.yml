image: node:15.4.0

#AWS access keys stored as secret variables 
variables:
  AWS_SECRET_ACCESS_KEY: $Private_Key


#This command is run before actual stages start running
before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - set -e
  - eval $(ssh-agent -s)
  - echo "${AWS_SECRET_ACCESS_KEY}" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh
  - touch ~/.ssh/config
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" >> ~/.ssh/config

#This declares the pipeline stages  
stages:
  - deploy

deployToAWS:
  only:
    - master
  stage: deploy
  script:
    - ssh ubuntu@ec2-52-23-188-28.compute-1.amazonaws.com " cd /home/ubuntu/vls_backend/ &&git pull origin master && sequelize-cli db:migrate && sudo yarn install --ignore-engines && pm2 restart vls_backend && exit"
