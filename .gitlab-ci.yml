image: node:15.4.0

#AWS access keys stored as secret variables 
variables:
  AWS_SECRET_ACCESS_KEY: $Private_Key


#This command is run before actual stages start running
before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - set -e
  - eval $(ssh-agent -s)
  - echo "${AWS_SECRET_ACCESS_KEY}" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh
  - touch ~/.ssh/config
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" >> ~/.ssh/config 
  # - ssh ubuntu@ec2-54-172-182-54.compute-1.amazonaws.com

#This declares the pipeline stages  
stages:
  - deploy

deployToAWS:
  only:
    - master
  stage: deploy
  script:
    - ssh ubuntu@ec2-54-172-182-54.compute-1.amazonaws.com " ls &&  cd /home/ubuntu/vls_backend/ && ls &&git pull origin master && npx sequelize-cli db:migrate && yarn install && pm2 restart 0  && exit"
    # - cd /home/ubuntu/vls_backend/
    # - ls
#    - git pull origin master
#    - npx sequelize-cli db:migrate
#    - yarn install
#    - pm2 restart 0  
